name: Manage Dev Server

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'ê°œë°œ ì„œë²„ ê´€ë¦¬'
        required: true
        type: choice
        options:
          - start
          - stop
          - update
          - status

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
  RDS_INSTANCE_ID: ${{ secrets.RDS_INSTANCE_ID }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: backend-ecr
  IMAGE_TAG: latest

jobs:
  manage-server:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› Debug Input Value
        run: |
          echo "Selected Action: [${{ inputs.action }}]"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}

      - name: Start RDS & EC2
        if: inputs.action == 'start'
        run: |
          echo "ğŸš€ Starting RDS..."
          aws rds start-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} || echo "RDS already running or processing"

          echo "â³ Waiting for RDS to be available... (This may take 3-5 mins)"
          aws rds wait db-instance-available --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
          echo "âœ… RDS is ready!"

          echo "ğŸš€ Starting EC2..."
          aws ec2 start-instances --instance-ids ${{ env.EC2_INSTANCE_ID }}
          
          echo "â³ Waiting for EC2 to be running..."
          aws ec2 wait instance-running --instance-ids ${{ env.EC2_INSTANCE_ID }}
          echo "âœ… EC2 is running!"

      - name: Stop EC2 & RDS
        if: inputs.action == 'stop'
        run: |
          echo "Stopping EC2..."
          aws ec2 stop-instances --instance-ids ${{ env.EC2_INSTANCE_ID }}
          
          echo "Stopping RDS..."
          aws rds stop-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} || echo "RDS already stopped"

      - name: Check Status
        if: inputs.action == 'status'
        run: |
          EC2_STATE=$(aws ec2 describe-instances --instance-ids ${{ env.EC2_INSTANCE_ID }} --query "Reservations[*].Instances[*].State.Name" --output text)
          RDS_STATE=$(aws rds describe-db-instances --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} --query "DBInstances[*].DBInstanceStatus" --output text)
          
          echo "### ğŸ” í˜„ì¬ ì„œë²„ ìƒíƒœ ë³´ê³ ì„œ" >> $GITHUB_STEP_SUMMARY
          echo "| ë¦¬ì†ŒìŠ¤ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$EC2_STATE" == "running" ]; then
            echo "| EC2 | âœ… ì‹¤í–‰ ì¤‘ (running) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| EC2 | ğŸ›‘ ì •ì§€ë¨ ($EC2_STATE) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$RDS_STATE" == "available" ]; then
            echo "| RDS | âœ… ì‚¬ìš© ê°€ëŠ¥ (available) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| RDS | ğŸ›‘ ì •ì§€/ì¤€ë¹„ ì¤‘ ($RDS_STATE) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deploy with SSM
        if: inputs.action == 'start' || inputs.action == 'update'
        run: |
          echo "ğŸš€ SSMìœ¼ë¡œ ë°°í¬ ëª…ë ¹ ì¤€ë¹„ ì¤‘..."
          
          # 1. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ íŒŒì¼ë¡œ ë¨¼ì € ì‘ì„±í•©ë‹ˆë‹¤.
          # (GitHub Actionsê°€ secrets ë³€ìˆ˜ë“¤ì„ ì´ íŒŒì¼ ì•ˆì— ì˜ˆì˜ê²Œ ì±„ì›Œì¤ë‹ˆë‹¤)
          cat <<EOF > deploy_script.sh
          #!/bin/bash
          export AWS_DEFAULT_REGION=${{ env.AWS_REGION }}
          
          # ECR ë¡œê·¸ì¸
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          
          # ì´ë¯¸ì§€ Pull
          docker pull ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
          docker stop my-app || true
          docker rm my-app || true

          docker run -d --name my-app \
            -p 80:8080 \
            --env-file /home/ec2-user/.env \
            ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          EOF

          # 2. ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©ì„ Base64ë¡œ ì¸ì½”ë”©í•©ë‹ˆë‹¤. (íŠ¹ìˆ˜ë¬¸ì ì—ëŸ¬ ì›ì²œ ì°¨ë‹¨)
          B64_SCRIPT=$(base64 -w 0 deploy_script.sh)
          
          # 3. ì¸ì½”ë”©ëœ ì½”ë“œë¥¼ SSMìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
          # (EC2 ë‚´ë¶€ì—ì„œ: base64 ë””ì½”ë”© -> ë°”ë¡œ ì‹¤í–‰)
          echo "ğŸš€ SSM ëª…ë ¹ ì „ì†¡ ì¤‘..."
          SH_ID=$(aws ssm send-command \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[echo $B64_SCRIPT | base64 -d | bash]" \
            --query "Command.CommandId" \
            --output text)
          
          echo "â³ ëª…ë ¹ ì‹¤í–‰ ì‹œì‘ (ID: $SH_ID)"
          
          # 4. ê²°ê³¼ ëŒ€ê¸°
          while true; do
            STATUS=$(aws ssm get-command-invocation --command-id "$SH_ID" --instance-id ${{ env.EC2_INSTANCE_ID }} --query "Status" --output text)
          
            if [ "$STATUS" == "Success" ]; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
              exit 0
            elif [ "$STATUS" == "Failed" ] || [ "$STATUS" == "Cancelled" ] || [ "$STATUS" == "TimedOut" ]; then
              echo "âŒ ë°°í¬ ì‹¤íŒ¨! ($STATUS)"
              aws ssm get-command-invocation --command-id "$SH_ID" --instance-id ${{ env.EC2_INSTANCE_ID }} --query "StandardErrorContent" --output text
              exit 1
            fi
          
            echo "Thinking... ($STATUS)"
            sleep 3
          done
