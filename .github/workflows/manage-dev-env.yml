name: Manage Dev Server

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'ê°œë°œ ì„œë²„'
        required: true
        type: choice
        options:
          - status
          - update
          - start
          - stop
permissions:
  id-token: write
  contents: read
env:
  AWS_REGION: ap-northeast-2
  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
  RDS_INSTANCE_ID: ${{ secrets.RDS_INSTANCE_ID }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  IMAGE_TAG: latest

jobs:
  manage-dev-server:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - name: Fetch Current Status
        id: fetch-status
        run: |
          # 1. EC2 ìƒíƒœ ì¡°íšŒ -> EC2_STATUS ë³€ìˆ˜ì— ì €ì¥
          EC2_STATE=$(aws ec2 describe-instances --instance-ids ${{ env.EC2_INSTANCE_ID }} --query "Reservations[*].Instances[*].State.Name" --output text)
          echo "EC2_STATUS=$EC2_STATE" >> $GITHUB_ENV
          
          # 2. RDS ìƒíƒœ ì¡°íšŒ -> RDS_STATUS ë³€ìˆ˜ì— ì €ì¥
          RDS_STATE=$(aws rds describe-db-instances --db-instance-identifier ${{ env.RDS_INSTANCE_ID }} --query "DBInstances[*].DBInstanceStatus" --output text)
          echo "RDS_STATUS=$RDS_STATE" >> $GITHUB_ENV

      - name: Report Status Summary
        if: inputs.action == 'status'
        run: |
          echo "### ğŸ” ì„œë²„ ìƒíƒœ ë³´ê³ ì„œ" >> $GITHUB_STEP_SUMMARY
          echo "| ë¦¬ì†ŒìŠ¤ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ env.EC2_STATUS }}" == "running" ]; then
            echo "| EC2 | âœ… ì‹¤í–‰ ì¤‘ (running) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| EC2 | ğŸ›‘ ì •ì§€/ëŒ€ê¸° ì¤‘ (${{ env.EC2_STATUS }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ env.RDS_STATUS }}" == "available" ]; then
            echo "| RDS | âœ… ì‚¬ìš© ê°€ëŠ¥ (available) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| RDS | ğŸ›‘ ì •ì§€/ì¤€ë¹„ ì¤‘ (${{ env.RDS_STATUS }}) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Start RDS & EC2
        if: inputs.action == 'start'
        run: |
          if [ "${{ env.RDS_STATUS }}" == "stopped" ]; then
             echo "ğŸš€ RDSê°€ ì •ì§€ ìƒíƒœì…ë‹ˆë‹¤. ì‹œì‘ ëª…ë ¹ì„ ì „ì†¡í•©ë‹ˆë‹¤..."
             aws rds start-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
             echo "â³ RDSê°€ ì¼œì§ˆ ë•Œê¹Œì§€ ëŒ€ê¸°í•©ë‹ˆë‹¤..."
             aws rds wait db-instance-available --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
             echo "âœ… RDS ì¤€ë¹„ ì™„ë£Œ!"
          elif [ "${{ env.RDS_STATUS }}" == "available" ]; then
             echo "âœ… RDSê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. (Pass)"
          else
             # stopping, rebooting, backing-up ë“± ì• ë§¤í•œ ìƒíƒœ
             echo "âš ï¸ RDSë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ìƒíƒœ: [${{ env.RDS_STATUS }}]"
             echo "   (í™•ì‹¤íˆ ì •ì§€ëœ ìƒíƒœ(stopped)ì—ì„œë§Œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)"
          fi

          if [ "${{ env.EC2_STATUS }}" == "stopped" ]; then
             echo "ğŸš€ EC2ê°€ ì •ì§€ ìƒíƒœì…ë‹ˆë‹¤. ì‹œì‘í•©ë‹ˆë‹¤..."
             aws ec2 start-instances --instance-ids ${{ env.EC2_INSTANCE_ID }}
             echo "â³ EC2 ë¶€íŒ… ëŒ€ê¸° ì¤‘..."
             aws ec2 wait instance-running --instance-ids ${{ env.EC2_INSTANCE_ID }}
             echo "âœ… EC2 ì‹¤í–‰ ì™„ë£Œ!"
          elif [ "${{ env.EC2_STATUS }}" == "running" ]; then
             echo "âœ… EC2ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. (Pass)"
          else
             # stopping, pending, shutting-down ë“±
             echo "âš ï¸ EC2ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ìƒíƒœ: [${{ env.EC2_STATUS }}]"
             echo "   (í™•ì‹¤íˆ ì •ì§€ëœ ìƒíƒœ(stopped)ì—ì„œë§Œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)"
          fi

      - name: Stop EC2 & RDS
        if: inputs.action == 'stop'
        run: |
          if [ "${{ env.EC2_STATUS }}" == "running" ]; then
             echo "ğŸ›‘ EC2ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì •ì§€ ëª…ë ¹ì„ ì „ì†¡í•©ë‹ˆë‹¤..."
             aws ec2 stop-instances --instance-ids ${{ env.EC2_INSTANCE_ID }}
             echo "â³ EC2ê°€ ì™„ì „íˆ êº¼ì§ˆ ë•Œê¹Œì§€ ëŒ€ê¸°í•©ë‹ˆë‹¤..."
             aws ec2 wait instance-stopped --instance-ids ${{ env.EC2_INSTANCE_ID }}
             echo "âœ… EC2 ì •ì§€ ì™„ë£Œ!"
          elif [ "${{ env.EC2_STATUS }}" == "stopped" ]; then
             echo "âœ… EC2ê°€ ì´ë¯¸ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤. (Pass)"
          else
             echo "âš ï¸ EC2ë¥¼ ì •ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ìƒíƒœ: [${{ env.EC2_STATUS }}]"
             echo "   (í™•ì‹¤íˆ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœ(running)ì—ì„œë§Œ ì •ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)"
          fi
          
          if [ "${{ env.RDS_STATUS }}" == "available" ]; then
             echo "ğŸ›‘ RDSê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì •ì§€ ëª…ë ¹ì„ ì „ì†¡í•©ë‹ˆë‹¤..."
             aws rds stop-db-instance --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
             echo "â³ RDSê°€ ì™„ì „íˆ êº¼ì§ˆ ë•Œê¹Œì§€ ëŒ€ê¸°í•©ë‹ˆë‹¤..."
             aws rds wait db-instance-stopped --db-instance-identifier ${{ env.RDS_INSTANCE_ID }}
             echo "âœ… RDS ì •ì§€ ì™„ë£Œ!"
          elif [ "${{ env.RDS_STATUS }}" == "stopped" ]; then
             echo "âœ… RDSê°€ ì´ë¯¸ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤. (Pass)"
          else
             echo "âš ï¸ RDSë¥¼ ì •ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ìƒíƒœ: [${{ env.RDS_STATUS }}]"
             echo "   (í™•ì‹¤íˆ ì‚¬ìš© ê°€ëŠ¥ ìƒíƒœ(available)ì—ì„œë§Œ ì •ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)"
          fi

      - name: Deploy with SSM
        if: inputs.action == 'start' || inputs.action == 'update'
        run: |
          if [ "${{ inputs.action }}" == "update" ] && [ "${{ env.EC2_STATUS }}" != "running" ]; then
            echo "âŒ [ì˜¤ë¥˜] ì„œë²„ê°€ ì •ì§€ëœ ìƒíƒœ(${{ env.EC2_STATUS }})ì—ì„œëŠ” Updateë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi
          
          echo "ğŸš€ SSMìœ¼ë¡œ ë°°í¬ ëª…ë ¹ ì¤€ë¹„ ì¤‘..."
          cat <<EOF > deploy_script.sh
          #!/bin/bash
          export AWS_DEFAULT_REGION=${{ env.AWS_REGION }}
          
          # ECR ë¡œê·¸ì¸
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          
          # ì´ë¯¸ì§€ Pull
          docker pull ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop app || true
          docker rm app || true

          docker run -d --name app \
            -p 80:8080 \
            --env-file /home/ec2-user/.env \
            ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          EOF
          
          B64_SCRIPT=$(base64 -w 0 deploy_script.sh)
          
          echo "ğŸš€ SSM ëª…ë ¹ ì „ì†¡ ì¤‘..."
          SH_ID=$(aws ssm send-command \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[echo $B64_SCRIPT | base64 -d | bash]" \
            --query "Command.CommandId" \
            --output text)
          
          echo "â³ ëª…ë ¹ ì‹¤í–‰ ì‹œì‘ (ID: $SH_ID)"
          
          while true; do
            STATUS=$(aws ssm get-command-invocation --command-id "$SH_ID" --instance-id ${{ env.EC2_INSTANCE_ID }} --query "Status" --output text)
            if [ "$STATUS" == "Success" ]; then echo "âœ… ë°°í¬ ì„±ê³µ!"; exit 0; 
            elif [ "$STATUS" == "Failed" ] || [ "$STATUS" == "Cancelled" ] || [ "$STATUS" == "TimedOut" ]; then
              echo "âŒ ë°°í¬ ì‹¤íŒ¨! ($STATUS)"
              aws ssm get-command-invocation --command-id "$SH_ID" --instance-id ${{ env.EC2_INSTANCE_ID }} --query "StandardErrorContent" --output text
              exit 1
            fi
            echo "Thinking... ($STATUS)"; sleep 3
          done
